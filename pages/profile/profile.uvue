<template>
	<view class="profile-container">
		<!-- é¡¶éƒ¨æ ‡é¢˜ -->
		<view class="header">
			<text class="app-title">æˆ‘çš„</text>
		</view>

		<!-- ä¸»è¦å†…å®¹ -->
		<scroll-view class="main-content" scroll-y="true">
			<!-- æœªç™»å½•çŠ¶æ€ -->
			<view v-if="!isLoggedIn" class="login-section">
				<button class="login-btn" @click="goToLogin">ç™»å½•ä½“éªŒå®Œæ•´åŠŸèƒ½</button>
			</view>

			<!-- å·²ç™»å½•çŠ¶æ€ -->
			<view v-else class="user-section">
				<!-- ç”¨æˆ·ä¿¡æ¯ -->
				<view class="user-info">
					<view class="avatar" v-if="!userInfo.avatar">
						<text class="avatar-text">{{userInfo.nickname.charAt(0)}}</text>
					</view>
					<image class="avatar-image" v-else :src="userInfo.avatar" mode="aspectFill" />
					<view class="user-details">
						<text class="user-name">{{userInfo.nickname}}</text>
						<text class="user-id">ç”¨æˆ·ID: {{userInfo.userId}}</text>
						<text class="phone-status" v-if="userInfo.phoneBound" :class="{ bound: userInfo.phoneBound }">
							ğŸ“± æ‰‹æœºå·²ç»‘å®š
						</text>
						<text class="phone-status" v-else>
							ğŸ“± æ‰‹æœºæœªç»‘å®š
						</text>
					</view>
					<text class="edit-link" @click="goToEditProfile">ç¼–è¾‘èµ„æ–™</text>
				</view>

				<!-- ä¼šå‘˜å’Œç¡¬å¸ä¿¡æ¯ -->
				<view class="member-section">
					<view class="member-info">
						<text class="member-type">{{userInfo.isVip ? 'VIPä¼šå‘˜' : 'æ™®é€šç”¨æˆ·'}}						<text class="member-promo" v-if="!userInfo.isVip">å‡çº§ä¼šå‘˜é™æ—¶é€ç¡¬å¸</text>
					</text>
					</view>
					<button class="upgrade-btn" v-if="!userInfo.isVip" @click="goToUpgradeMember">å‡çº§ä¼šå‘˜</button>
				</view>

				<!-- æ•°æ®ç»Ÿè®¡ -->
				<view class="stats-section">
					<view class="stat-item">
						<text class="stat-number">{{userInfo.coins}}</text>
						<text class="stat-label">åˆ›ä½œç¡¬å¸</text>
						<button class="recharge-btn" @click="goToRecharge">å……å€¼</button>
					</view>
					<view class="stat-item">
						<text class="stat-number">{{userInfo.rechargeOrders}}</text>
						<text class="stat-label">å……å€¼è®¢å•</text>
					</view>
					<view class="stat-item">
						<text class="stat-number">{{userInfo.questionRecords}}</text>
						<text class="stat-label">æé—®è®°å½•</text>
					</view>
					<view class="stat-item">
						<text class="stat-number">{{userInfo.creationRecords}}</text>
						<text class="stat-label">åˆ›ä½œè®°å½•</text>
					</view>
				</view>
			</view>

			<!-- åŠŸèƒ½èœå• -->
			<view class="menu-section">
				<view class="menu-item" @click="inviteFriends" v-if="isLoggedIn">
					<text class="menu-text">é‚€è¯·å¥½å‹</text>
					<text class="menu-desc">æˆåŠŸé‚€è¯·æ–°ç”¨æˆ·æ³¨å†Œï¼Œå¯è·å¾—1ä¸‡ç¡¬å¸</text>
					<text class="menu-arrow"></text>
				</view>
				
				<view class="menu-item" @click="goToShareEarn" v-if="isLoggedIn">
					<text class="menu-text">åˆ†äº«èµšç¡¬å¸</text>
					<text class="menu-arrow"></text>
				</view>
				
				<view class="menu-item" @click="goToDesktop">
					<text class="menu-text">ç”µè„‘ç‰ˆ</text>
					<view class="menu-right">
						<text class="menu-url">https://www.wsxai.com/</text>
					</view>
				</view>
				
				<view class="menu-item" @click="goToUsageGuide">
					<text class="menu-text">ä½¿ç”¨è¯´æ˜</text>
				</view>
				
				<view class="menu-item" @click="contactService">
					<text class="menu-text">è”ç³»å®¢æœ</text>
				</view>
				
				<view class="menu-item" @click="goToAccountSecurity" v-if="isLoggedIn">
					<text class="menu-text">è´¦å·åŠå®‰å…¨</text>
				</view>
				
				<view class="menu-item" @click="goToAboutUs">
					<text class="menu-text">å…³äºæˆ‘ä»¬</text>
				</view>
				
				<view class="menu-item" @click="goToFeedback">
					<text class="menu-text">æ„è§åé¦ˆ</text>
				</view>
			</view>

			<!-- é€€å‡ºç™»å½• -->
			<view class="logout-section" v-if="isLoggedIn">
				<button class="logout-btn" @click="logout">é€€å‡ºç™»å½•</button>
			</view>

			<!-- åº•éƒ¨ä¿¡æ¯ -->
			<view class="footer-section">
				<text class="copyright">@ 2024 guanzhi.com.cn Â©å† æ™ºæœªæ¥ç§‘æŠ€æœ‰é™å…¬å¸</text>
				<text class="icp">æ²ªICPå¤‡2024000000å·-1 | æ²ªå…¬ç½‘å®‰å¤‡: 31010402000000å·</text>
			</view>
		</scroll-view>
	</view>
</template>

<script>
import auth from '@/utils/auth.js'

export default {
	data() {
		return {
			isLoggedIn: false,
			userInfo: {
				nickname: 'inner2466',
				userId: '1933438229252542466',
				isVip: false,
				coins: 5000,
				rechargeOrders: 0,
				questionRecords: 0,
				creationRecords: 0
			}
		}
	},
	onLoad() {
		this.loadUserData()
	},
	
	onShow() {
		// æ¯æ¬¡æ˜¾ç¤ºé¡µé¢æ—¶é‡æ–°åŠ è½½æ•°æ®ï¼Œç¡®ä¿æ˜¾ç¤ºæœ€æ–°ä¿¡æ¯
		console.log('Profileé¡µé¢ - onShow è§¦å‘')
		this.loadUserData()
		
		// æ£€æŸ¥æ˜¯å¦æœ‰ç™»å½•çŠ¶æ€æ›´æ–°
		if (auth.checkAndClearLoginStatusUpdated()) {
			console.log('Profileé¡µé¢ - æ£€æµ‹åˆ°ç™»å½•çŠ¶æ€æ›´æ–°ï¼Œé‡æ–°æ£€æŸ¥')
			this.loadUserData()
		}
	},
	
	methods: {
		// åŠ è½½ç”¨æˆ·æ•°æ®
		loadUserData() {
			// ä½¿ç”¨å…¨å±€ç™»å½•çŠ¶æ€ç®¡ç†å·¥å…·
			const result = auth.checkLoginStatus()
			
			if (result.isLoggedIn) {
				this.isLoggedIn = true
				this.userInfo = { ...this.userInfo, ...result.userInfo }
				console.log('Profileé¡µé¢ - ç™»å½•æˆåŠŸï¼Œç”¨æˆ·ä¿¡æ¯:', this.userInfo)
				
				// ä»æœ¬åœ°å­˜å‚¨åŠ è½½å¤´åƒ
				const savedAvatar = uni.getStorageSync('userAvatar')
				if (savedAvatar) {
					this.userInfo.avatar = savedAvatar
				}
				
				// æ£€æŸ¥æ‰‹æœºç»‘å®šçŠ¶æ€
				const phoneBound = uni.getStorageSync('phoneBound')
				if (phoneBound) {
					this.userInfo.phoneBound = true
					// ç¡®ä¿ç”¨æˆ·ä¿¡æ¯ä¸­ä¹ŸåŒ…å«æ‰‹æœºç»‘å®šçŠ¶æ€
					if (!this.userInfo.phoneBound) {
						this.userInfo.phoneBound = true
						uni.setStorageSync('userInfo', this.userInfo)
					}
				}
			} else {
				this.isLoggedIn = false
				this.userInfo = {
					nickname: '',
					userId: '',
					isVip: false,
					coins: 0,
					rechargeOrders: 0,
					questionRecords: 0,
					creationRecords: 0
				}
				console.log('Profileé¡µé¢ - æœªç™»å½•çŠ¶æ€')
			}
		},
		
		// æ¸…é™¤ç™»å½•æ•°æ®
		clearLoginData() {
			// ä½¿ç”¨å…¨å±€ç™»å½•çŠ¶æ€ç®¡ç†å·¥å…·æ¸…é™¤æ•°æ®
			auth.clearLoginData()
			
			this.isLoggedIn = false
			this.userInfo = {
				nickname: '',
				userId: '',
				isVip: false,
				coins: 0,
				rechargeOrders: 0,
				questionRecords: 0,
				creationRecords: 0
			}
		},
		
		// è·³è½¬åˆ°ç™»å½•é¡µé¢
		goToLogin() {
			uni.navigateTo({
				url: '/pages/login/login'
			})
		},
		
		// é€€å‡ºç™»å½•
		logout() {
			uni.showModal({
				title: 'ç¡®è®¤é€€å‡º',
				content: 'ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ',
				success: (res) => {
					if (res.confirm) {
						// ä½¿ç”¨å…¨å±€ç™»å½•çŠ¶æ€ç®¡ç†å·¥å…·æ¸…é™¤æ•°æ®
						auth.clearLoginData()
						
						this.isLoggedIn = false
						this.userInfo = {
							nickname: '',
							userId: '',
							isVip: false,
							coins: 0,
							rechargeOrders: 0,
							questionRecords: 0,
							creationRecords: 0
						}
						
						uni.showToast({
							title: 'å·²é€€å‡ºç™»å½•',
							icon: 'success'
						})
					}
				}
			})
		},
		
		// é¡µé¢è·³è½¬æ–¹æ³•
		goToEditProfile() {
			uni.navigateTo({
				url: '/pages/profile/edit-profile/edit-profile'
			})
		},
		
		goToUpgradeMember() {
			uni.navigateTo({
				url: '/pages/profile/upgrade-member/upgrade-member'
			})
		},
		
		goToRecharge() {
			uni.navigateTo({
				url: '/pages/profile/recharge/recharge'
			})
		},
		
		inviteFriends() {
			uni.showActionSheet({
				itemList: ['åˆ†äº«ç»™å¾®ä¿¡å¥½å‹', 'å¤åˆ¶é‚€è¯·é“¾æ¥'],
				success: (res) => {
					if (res.tapIndex === 0) {
						// åˆ†äº«ç»™å¾®ä¿¡å¥½å‹
						uni.share({
							provider: 'weixin',
							scene: 'WXSceneSession',
							type: 0,
							href: 'https://www.wsxai.com/invite?code=inner2466',
							title: 'å† æ™ºæœªæ¥æ–‡æ›²æ˜Ÿå°ç¨‹åº',
							summary: 'é‚€è¯·æ‚¨ä½¿ç”¨å† æ™ºæœªæ¥æ–‡æ›²æ˜Ÿå°ç¨‹åºï¼ŒæˆåŠŸæ³¨å†Œå¯è·å¾—1ä¸‡ç¡¬å¸å¥–åŠ±ï¼',
							imageUrl: '/static/logo.png',
							success: () => {
								uni.showToast({
									title: 'åˆ†äº«æˆåŠŸ',
									icon: 'success'
								})
							},
							fail: () => {
								uni.showToast({
									title: 'åˆ†äº«å¤±è´¥',
									icon: 'none'
								})
							}
						})
					} else if (res.tapIndex === 1) {
						// å¤åˆ¶é‚€è¯·é“¾æ¥
						const inviteLink = 'https://www.wsxai.com/invite?code=inner2466'
						uni.setClipboardData({
							data: inviteLink,
							success: () => {
								uni.showToast({
									title: 'é‚€è¯·é“¾æ¥å·²å¤åˆ¶',
									icon: 'success'
								})
							}
						})
					}
				}
			})
		},
		
		goToShareEarn() {
			uni.navigateTo({
				url: '/pages/profile/share-earn/share-earn'
			})
		},
		
		goToDesktop() {
			uni.navigateTo({
				url: '/pages/webview/webview?url=' + encodeURIComponent('https://www.wsxai.com/')
			})
		},
		
		goToUsageGuide() {
			uni.navigateTo({
				url: '/pages/profile/usage-guide/usage-guide'
			})
		},
		
		contactService() {
			uni.showActionSheet({
				itemList: ['åœ¨çº¿å®¢æœ', 'æ‹¨æ‰“å®¢æœç”µè¯'],
				success: (res) => {
					if (res.tapIndex === 0) {
						// åœ¨çº¿å®¢æœ
						uni.navigateTo({
							url: '/pages/profile/customer-service/customer-service'
						})
					} else if (res.tapIndex === 1) {
						// æ‹¨æ‰“å®¢æœç”µè¯
						uni.makePhoneCall({
							phoneNumber: '400-123-4567',
							success: () => {
								uni.showToast({
									title: 'æ­£åœ¨æ‹¨æ‰“å®¢æœç”µè¯',
									icon: 'none'
								})
							}
						})
					}
				}
			})
		},
		
		goToAccountSecurity() {
			uni.navigateTo({
				url: '/pages/profile/account-security/account-security'
			})
		},
		
		goToAboutUs() {
			uni.navigateTo({
				url: '/pages/profile/about-us/about-us'
			})
		},
		
		goToFeedback() {
			uni.navigateTo({
				url: '/pages/profile/feedback/feedback'
			})
		}
	}
}
</script>

<style>
.profile-container {
	flex: 1;
	background-color: #ffffff;
}

/* é¡¶éƒ¨æ ‡é¢˜ */
.header {
	display: flex;
	justify-content: center;
	align-items: center;
	padding: 30rpx;
	border-bottom: 1rpx solid #e0e0e0;
}

.app-title {
	font-size: 36rpx;
	font-weight: 600;
	color: #000000;
}

/* ä¸»è¦å†…å®¹ */
.main-content {
	flex: 1;
	padding: 30rpx;
}

/* ç™»å½•åŒºåŸŸ */
.login-section {
	display: flex;
	flex-direction: column;
	align-items: center;
	margin-bottom: 60rpx;
}

.login-title {
	font-size: 48rpx;
	font-weight: 600;
	color: #000000;
	margin-bottom: 40rpx;
}

.login-btn {
	width: 100%;
	height: 100rpx;
	background: linear-gradient(90deg, #007aff 0%, #00c851 100%);
	color: #ffffff;
	border: none;
	border-radius: 16rpx;
	font-size: 32rpx;
	font-weight: 500;
	display: flex;
	align-items: center;
	justify-content: center;
}

/* ç”¨æˆ·ä¿¡æ¯åŒºåŸŸ */
.user-section {
	margin-bottom: 40rpx;
}

.user-info {
	display: flex;
	align-items: center;
	padding: 30rpx 0;
	border-bottom: 1rpx solid #f0f0f0;
}

.avatar {
	width: 100rpx;
	height: 100rpx;
	background-color: #007aff;
	border-radius: 50%;
	display: flex;
	align-items: center;
	justify-content: center;
	margin-right: 25rpx;
}

.avatar-text {
	font-size: 36rpx;
	font-weight: 600;
	color: #ffffff;
}

.avatar-image {
	width: 100rpx;
	height: 100rpx;
	border-radius: 50%;
}

.user-details {
	flex: 1;
}

.user-name {
	font-size: 32rpx;
	font-weight: 600;
	color: #000000;
	display: block;
	margin-bottom: 8rpx;
}

.user-id {
	font-size: 24rpx;
	color: #666666;
	display: block;
}

.phone-status {
	font-size: 22rpx;
	color: #ff3b30;
	display: block;
	margin-top: 8rpx;
}

.phone-status.bound {
	color: #00c851;
}

.edit-link {
	font-size: 26rpx;
	color: #007aff;
}

/* ä¼šå‘˜ä¿¡æ¯ */
.member-section {
	display: flex;
	justify-content: space-between;
	align-items: center;
	padding: 25rpx 0;
	border-bottom: 1rpx solid #f0f0f0;
}

.member-info {
	display: flex;
	flex-direction: column;
}

.member-type {
	font-size: 28rpx;
	color: #000000;
	margin-bottom: 8rpx;
}

.member-promo {
	font-size: 24rpx;
	color: #ff3b30;
}

.upgrade-btn {
	background: linear-gradient(90deg, #007aff 0%, #00c851 100%);
	color: #ffffff;
	border: none;
	border-radius: 8rpx;
	padding: 12rpx 24rpx;
	font-size: 26rpx;
}

/* æ•°æ®ç»Ÿè®¡ */
.stats-section {
	display: grid;
	grid-template-columns: 1fr 1fr 1fr 1fr;
	gap: 20rpx;
	padding: 25rpx 0;
}

.stat-item {
	display: flex;
	flex-direction: column;
	align-items: center;
	text-align: center;
}

.stat-number {
	font-size: 32rpx;
	font-weight: 600;
	color: #000000;
	margin-bottom: 8rpx;
}

.stat-label {
	font-size: 22rpx;
	color: #666666;
	margin-bottom: 8rpx;
}

.recharge-btn {
	background-color: #007aff;
	color: #ffffff;
	border: none;
	border-radius: 6rpx;
	padding: 6rpx 12rpx;
	font-size: 20rpx;
}

/* åŠŸèƒ½èœå• */
.menu-section {
	background-color: #ffffff;
	border-radius: 12rpx;
	overflow: hidden;
	margin-bottom: 40rpx;
}

.menu-item {
	display: flex;
	justify-content: space-between;
	align-items: center;
	padding: 30rpx;
	border-bottom: 1rpx solid #f0f0f0;
	position: relative;
}

.menu-item:last-child {
	border-bottom: none;
}

.menu-text {
	font-size: 30rpx;
	color: #000000;
}

.menu-desc {
	position: absolute;
	left: 30rpx;
	top: 70rpx;
	font-size: 22rpx;
	color: #666666;
}

.menu-right {
	display: flex;
	align-items: center;
	gap: 15rpx;
}

.menu-url {
	font-size: 24rpx;
	color: #666666;
}

.menu-arrow {
	width: 0;
	height: 0;
	border-left: 12rpx solid #c0c0c0;
	border-top: 8rpx solid transparent;
	border-bottom: 8rpx solid transparent;
}

/* é€€å‡ºç™»å½• */
.logout-section {
	margin-bottom: 40rpx;
}

.logout-btn {
	width: 100%;
	background-color: #ffffff;
	color: #ff3b30;
	border: 1rpx solid #ff3b30;
	border-radius: 12rpx;
	padding: 25rpx;
	font-size: 30rpx;
}

/* åº•éƒ¨ä¿¡æ¯ */
.footer-section {
	display: flex;
	flex-direction: column;
	gap: 10rpx;
	padding: 40rpx 0;
}

.copyright {
	font-size: 24rpx;
	color: #999999;
	text-align: center;
}

.icp {
	font-size: 22rpx;
	color: #999999;
	text-align: center;
}
</style> 