<template>
	<view class="knowledge-container">
		<!-- é¡¶éƒ¨çŠ¶æ€æ  -->
		<view class="status-bar">
			<text class="app-name">å† æ™ºæœªæ¥å†™ä½œåŠ©æ‰‹</text>
			<view class="header-icons">
				<text class="icon">â‹¯</text>
				<text class="icon">âš™ï¸</text>
			</view>
		</view>

		<!-- ç”¨æˆ·çŠ¶æ€åŒºåŸŸ - ç™»å½•å’Œå‡çº§äº’æ–¥æ˜¾ç¤º -->
		<view class="user-status-section">
			<!-- æœªç™»å½•çŠ¶æ€ï¼šæ˜¾ç¤ºç™»å½•æŒ‰é’® -->
			<view v-if="!isLoggedIn" class="user-status-left">
				<button class="login-btn" @click="goToLogin">ç™»å½•</button>
			</view>
			
			<!-- å·²ç™»å½•çŠ¶æ€ï¼šæ˜¾ç¤ºç”¨æˆ·ç±»å‹å’Œå‡çº§æŒ‰é’® -->
			<view v-else class="user-status-left">
				<text class="user-type">{{ userInfo.isVip ? 'VIPç”¨æˆ·' : 'æ™®é€šç”¨æˆ·' }}</text>
				<button v-if="!userInfo.isVip" class="upgrade-btn" @click="goToUpgrade">å‡çº§</button>
			</view>
		</view>

		<!-- æ¨èæ¨ªå¹… -->
		<view class="recommend-banner" @click="goToDesktop">
			<text class="banner-text">æ›´æ¨èç”µè„‘ç«¯ä½¿ç”¨ï¼ŒåŠŸèƒ½æ›´å¼ºå¤§: www.wsxai.com</text>
		</view>

		<!-- ä¸»è¦å†…å®¹ -->
		<scroll-view class="main-content" scroll-y="true">
			<!-- çŸ¥è¯†åº“æ ‡é¢˜åŒºåŸŸ -->
			<view class="knowledge-header">
				<view class="section-title">
					<text class="title-text">
						<text class="title-icon">ğŸ“š</text>
						çŸ¥è¯†åº“<text class="title-desc">AIçŸ¥è¯†ç®¡ç†ï¼Œæ™ºèƒ½æ£€ç´¢</text>
					</text>
				</view>
			</view>

			<!-- æ“ä½œæŒ‰é’®åŒºåŸŸ -->
			<view class="action-buttons">
				<view class="action-btn upload-btn" @click="showDocumentUpload">
					<view class="btn-icon">ğŸ“„</view>
					<text class="btn-text">æ–‡æ¡£ä¸Šä¼ </text>
					<text class="btn-desc">æ”¯æŒå¤šç§æ–‡æ¡£æ ¼å¼</text>
				</view>
				<view class="action-btn capture-btn" @click="showWebCapture">
					<view class="btn-icon">ğŸŒ</view>
					<text class="btn-text">ç½‘é¡µæŠ“å–</text>
					<text class="btn-desc">æ™ºèƒ½æå–ç½‘é¡µå†…å®¹</text>
				</view>
			</view>

			<!-- çŸ¥è¯†åº“å†…å®¹å±•ç¤ºåŒºåŸŸ -->
			<view class="knowledge-content">
				<!-- æ— æ•°æ®çŠ¶æ€ -->
				<view v-if="knowledgeItems.length === 0" class="empty-state">
					<view class="empty-illustration">
						<view class="desk">
							<view class="laptop"></view>
							<view class="arrow"></view>
							<view class="box"></view>
						</view>
						<view class="person">
							<view class="head"></view>
							<view class="body"></view>
						</view>
					</view>
					<text class="empty-text">æ— æ•°æ®</text>
					<text class="empty-desc">ä¸Šä¼ æ–‡æ¡£æˆ–æŠ“å–ç½‘é¡µå¼€å§‹æ„å»ºæ‚¨çš„çŸ¥è¯†åº“</text>
				</view>

				<!-- æœ‰æ•°æ®çŠ¶æ€ -->
				<view v-else class="knowledge-list">
					<view class="list-header">
						<text class="list-title">æˆ‘çš„çŸ¥è¯†åº“</text>
						<text class="list-count">({{ knowledgeItems.length }})</text>
					</view>
					<view class="knowledge-items">
						<view v-for="(item, index) in knowledgeItems" :key="index" class="knowledge-item">
							<view class="item-icon">{{ item.icon }}</view>
							<view class="item-content">
								<text class="item-title">{{ item.title }}</text>
								<text class="item-desc">{{ item.desc }}</text>
								<text class="item-time">{{ item.time }}</text>
							</view>
							<view class="item-actions">
								<text class="action-text">æŸ¥çœ‹</text>
							</view>
						</view>
					</view>
				</view>
			</view>
		</scroll-view>

		<!-- æ–‡æ¡£ä¸Šä¼ æ¨¡æ€æ¡† -->
		<view class="modal-overlay" v-if="showDocumentModal" @click="hideDocumentModal">
			<view class="modal-content" @click.stop>
				<view class="modal-header">
					<text class="modal-title">æ–‡æ¡£ä¸Šä¼ </text>
					<text class="close-btn" @click="hideDocumentModal">Ã—</text>
				</view>
				<view class="modal-body">
					<view class="upload-option" @click="selectFromWeChat">
						<text class="option-text">ä»å¾®ä¿¡èŠå¤©è®°å½•ä¸­é€‰æ‹©</text>
					</view>
					<view class="upload-option" @click="selectFromDevice">
						<text class="option-text">ä»è®¾å¤‡ä¸­é€‰æ‹©</text>
					</view>
				</view>
				<view class="modal-footer">
					<view class="cancel-btn" @click="hideDocumentModal">
						<text class="cancel-text">å–æ¶ˆ</text>
					</view>
				</view>
			</view>
		</view>

		<!-- ç½‘é¡µæŠ“å–æ¨¡æ€æ¡† -->
		<view class="modal-overlay" v-if="showWebModal" @click="hideWebModal">
			<view class="modal-content web-modal" @click.stop>
				<view class="modal-header">
					<text class="modal-title">ç½‘é¡µæŠ“å–</text>
					<text class="close-btn" @click="hideWebModal">Ã—</text>
				</view>
				<view class="modal-body">
					<view class="disclaimer">
						<text class="disclaimer-text">è¯·é¿å…éæ³•æŠ“å–ä»–äººç½‘ç«™çš„ä¾µæƒè¡Œä¸ºï¼Œä¿è¯é“¾æ¥å¯å…¬å¼€è®¿é—®ï¼Œä¸”ç½‘ç«™å†…å®¹å¯å¤åˆ¶æŠ“å–çš„ç½‘é¡µä»…ä¸ºå†…å®¹å›ºå®šä¸å˜çš„é™æ€ç½‘é¡µï¼Œä¾‹å¦‚æ–°é—»æ–‡ç« ã€äº§å“ä»‹ç»ç­‰</text>
					</view>
					<view class="input-area">
						<textarea 
							class="url-input" 
							placeholder="è¯·ç²˜è´´ç½‘ç«™æˆ–è¾“å…¥é“¾æ¥ï¼Œä¸€æ¬¡æ”¯æŒæ·»åŠ 1ä¸ªç½‘å€"
							v-model="webUrl"
							:maxlength="500"
						></textarea>
					</view>
				</view>
				<view class="modal-footer">
					<view class="cancel-btn" @click="hideWebModal">
						<text class="cancel-text">å–æ¶ˆ</text>
					</view>
					<view class="confirm-btn" @click="confirmWebCapture">
						<text class="confirm-text">ç¡®è®¤</text>
					</view>
				</view>
			</view>
		</view>
	</view>
</template>

<script>
import auth from '@/utils/auth.js'

export default {
	data() {
		return {
			isLoggedIn: false,
			userInfo: {
				isVip: false,
				nickname: '',
				coins: 0
			},
			showDocumentModal: false,
			showWebModal: false,
			webUrl: '',
			knowledgeItems: [] // çŸ¥è¯†åº“é¡¹ç›®åˆ—è¡¨
		}
	},
	onLoad() {
		this.checkLoginStatus()
	},
	onShow() {
		this.checkLoginStatus()
		
		// æ£€æŸ¥æ˜¯å¦æœ‰ç™»å½•çŠ¶æ€æ›´æ–°
		if (auth.checkAndClearLoginStatusUpdated()) {
			this.checkLoginStatus()
		}
	},
	methods: {
		checkLoginStatus() {
			// ä½¿ç”¨å…¨å±€ç™»å½•çŠ¶æ€ç®¡ç†å·¥å…·
			const result = auth.checkLoginStatus()
			
			console.log('çŸ¥è¯†åº“é¡µé¢ - æ£€æŸ¥ç™»å½•çŠ¶æ€:', result)
			
			if (result.isLoggedIn && result.userInfo) {
				this.isLoggedIn = true
				// ç¡®ä¿ç”¨æˆ·ä¿¡æ¯åŒ…å«å¿…è¦çš„å­—æ®µ
				this.userInfo = {
					isVip: result.userInfo.isVip || false,
					nickname: result.userInfo.nickname || 'ç”¨æˆ·',
					coins: result.userInfo.coins || 0,
					...result.userInfo
				}
				console.log('çŸ¥è¯†åº“é¡µé¢ - ç”¨æˆ·å·²ç™»å½•:', this.userInfo)
			} else {
				this.isLoggedIn = false
				this.userInfo = {
					isVip: false,
					nickname: '',
					coins: 0
				}
				console.log('çŸ¥è¯†åº“é¡µé¢ - ç”¨æˆ·æœªç™»å½•')
			}
		},
		
		goToLogin() {
			uni.navigateTo({
				url: '/pages/login/login'
			})
		},
		
		goToUpgrade() {
			uni.navigateTo({
				url: '/pages/profile/upgrade-member/upgrade-member'
			})
		},
		
		goToDesktop() {
			uni.navigateTo({
				url: '/pages/webview/webview?url=' + encodeURIComponent('https://www.wsxai.com/')
			})
		},
		
		// æ˜¾ç¤ºæ–‡æ¡£ä¸Šä¼ æ¨¡æ€æ¡†
		showDocumentUpload() {
			this.showDocumentModal = true;
		},
		
		// éšè—æ–‡æ¡£ä¸Šä¼ æ¨¡æ€æ¡†
		hideDocumentModal() {
			this.showDocumentModal = false;
		},
		
		// æ˜¾ç¤ºç½‘é¡µæŠ“å–æ¨¡æ€æ¡†
		showWebCapture() {
			this.showWebModal = true;
		},
		
		// éšè—ç½‘é¡µæŠ“å–æ¨¡æ€æ¡†
		hideWebModal() {
			this.showWebModal = false;
			this.webUrl = '';
		},
		
		// ä»å¾®ä¿¡é€‰æ‹©æ–‡ä»¶
		selectFromWeChat() {
			uni.showToast({
				title: 'ä»å¾®ä¿¡é€‰æ‹©åŠŸèƒ½å¼€å‘ä¸­',
				icon: 'none'
			});
			this.hideDocumentModal();
		},
		
		// ä»è®¾å¤‡é€‰æ‹©æ–‡ä»¶
		selectFromDevice() {
			uni.chooseFile({
				count: 1,
				type: 'all',
				success: (res) => {
					console.log('é€‰æ‹©çš„æ–‡ä»¶:', res.tempFiles);
					// æ¨¡æ‹Ÿæ·»åŠ åˆ°çŸ¥è¯†åº“
					this.addToKnowledge({
						icon: 'ğŸ“„',
						title: res.tempFiles[0].name,
						desc: 'æ–‡æ¡£ä¸Šä¼ ',
						time: 'åˆšåˆš'
					});
					uni.showToast({
						title: 'æ–‡ä»¶å·²æ·»åŠ åˆ°çŸ¥è¯†åº“',
						icon: 'success'
					});
					this.hideDocumentModal();
				},
				fail: (err) => {
					console.log('é€‰æ‹©æ–‡ä»¶å¤±è´¥:', err);
					uni.showToast({
						title: 'é€‰æ‹©æ–‡ä»¶å¤±è´¥',
						icon: 'none'
					});
				}
			});
		},
		
		// ç¡®è®¤ç½‘é¡µæŠ“å–
		confirmWebCapture() {
			if (!this.webUrl.trim()) {
				uni.showToast({
					title: 'è¯·è¾“å…¥ç½‘å€',
					icon: 'none'
				});
				return;
			}
			
			uni.showLoading({
				title: 'æŠ“å–ä¸­...'
			});
			
			// æ¨¡æ‹Ÿç½‘é¡µæŠ“å–
			setTimeout(() => {
				uni.hideLoading();
				// æ¨¡æ‹Ÿæ·»åŠ åˆ°çŸ¥è¯†åº“
				this.addToKnowledge({
					icon: 'ğŸŒ',
					title: 'ç½‘é¡µå†…å®¹',
					desc: 'ç½‘é¡µæŠ“å–',
					time: 'åˆšåˆš'
				});
				uni.showToast({
					title: 'ç½‘é¡µå·²æ·»åŠ åˆ°çŸ¥è¯†åº“',
					icon: 'success'
				});
				this.hideWebModal();
			}, 2000);
		},
		
		// æ·»åŠ åˆ°çŸ¥è¯†åº“
		addToKnowledge(item) {
			this.knowledgeItems.unshift(item);
		}
	}
}
</script>

<style>
.knowledge-container {
	flex: 1;
	background-color: #f8f8f8;
}

/* é¡¶éƒ¨çŠ¶æ€æ  */
.status-bar {
	display: flex;
	justify-content: space-between;
	align-items: center;
	padding: 20rpx 30rpx;
	background-color: #ffffff;
	border-bottom: 1rpx solid #e0e0e0;
}

.app-name {
	font-size: 32rpx;
	font-weight: 600;
	color: #333333;
}

.header-icons {
	display: flex;
	gap: 20rpx;
}

.icon {
	font-size: 24rpx;
	color: #666666;
	width: 40rpx;
	height: 40rpx;
	display: flex;
	align-items: center;
	justify-content: center;
}

/* ç”¨æˆ·çŠ¶æ€åŒºåŸŸ */
.user-status-section {
	display: flex;
	justify-content: space-between;
	align-items: center;
	padding: 20rpx 30rpx;
	background-color: #ffffff;
	border-bottom: 1rpx solid #e0e0e0;
}

.user-status-left {
	display: flex;
	align-items: center;
	gap: 20rpx;
}

.login-btn {
	background: linear-gradient(90deg, #1976ff, #1565c0);
	color: #ffffff;
	font-size: 28rpx;
	font-weight: 600;
	padding: 12rpx 24rpx;
	border-radius: 12rpx;
	border: none;
}

.user-type {
	font-size: 28rpx;
	color: #333333;
	font-weight: 600;
}

.upgrade-btn {
	background: linear-gradient(90deg, #4CAF50, #388E3C);
	color: #ffffff;
	font-size: 28rpx;
	font-weight: 600;
	padding: 12rpx 24rpx;
	border-radius: 12rpx;
	border: none;
}

/* æ¨èæ¨ªå¹… */
.recommend-banner {
	background: linear-gradient(90deg, #e8f5e8 0%, #f0f8f0 100%);
	padding: 16rpx 30rpx;
	text-align: center;
}

.banner-text {
	font-size: 24rpx;
	color: #4CAF50;
}

/* ä¸»è¦å†…å®¹ */
.main-content {
	flex: 1;
	padding: 30rpx;
}

/* çŸ¥è¯†åº“æ ‡é¢˜åŒºåŸŸ */
.knowledge-header {
	margin-bottom: 40rpx;
}

.section-title {
	display: flex;
	align-items: center;
	justify-content: space-between;
}

.title-text {
	font-size: 36rpx;
	font-weight: bold;
	color: #333333;
	display: flex;
	align-items: center;
	gap: 12rpx;
}

.title-icon {
	font-size: 32rpx;
}

.title-desc {
	font-size: 24rpx;
	color: #666666;
	font-weight: normal;
	margin-left: 12rpx;
}

/* æ“ä½œæŒ‰é’®åŒºåŸŸ */
.action-buttons {
	display: flex;
	flex-direction: column;
	gap: 24rpx;
	margin-bottom: 40rpx;
}

.action-btn {
	background: linear-gradient(90deg, #1976ff, #1565c0);
	border-radius: 16rpx;
	padding: 32rpx 24rpx;
	display: flex;
	align-items: center;
	gap: 20rpx;
	box-shadow: 0 4rpx 12rpx rgba(25, 118, 255, 0.15);
}

.btn-icon {
	font-size: 40rpx;
	width: 60rpx;
	height: 60rpx;
	background: rgba(255, 255, 255, 0.2);
	border-radius: 12rpx;
	display: flex;
	align-items: center;
	justify-content: center;
}

.btn-text {
	font-size: 32rpx;
	color: #ffffff;
	font-weight: 600;
	flex: 1;
}

.btn-desc {
	font-size: 24rpx;
	color: rgba(255, 255, 255, 0.8);
}

/* çŸ¥è¯†åº“å†…å®¹å±•ç¤ºåŒºåŸŸ */
.knowledge-content {
	background: #ffffff;
	border-radius: 16rpx;
	padding: 30rpx;
	box-shadow: 0 2rpx 8rpx rgba(0, 0, 0, 0.04);
}

/* ç©ºçŠ¶æ€ */
.empty-state {
	display: flex;
	flex-direction: column;
	align-items: center;
	padding: 60rpx 0;
}

.empty-illustration {
	position: relative;
	width: 300rpx;
	height: 200rpx;
	margin-bottom: 30rpx;
}

.desk {
	position: absolute;
	left: 50rpx;
	bottom: 30rpx;
	width: 200rpx;
	height: 20rpx;
	background-color: #8d6e63;
	border-radius: 10rpx;
}

.laptop {
	position: absolute;
	left: 50rpx;
	bottom: 40rpx;
	width: 60rpx;
	height: 40rpx;
	background-color: #424242;
	border-radius: 8rpx;
}

.arrow {
	position: absolute;
	left: 120rpx;
	bottom: 50rpx;
	width: 40rpx;
	height: 4rpx;
	background-color: #666666;
	border-radius: 2rpx;
}

.arrow::after {
	content: '';
	position: absolute;
	right: -6rpx;
	top: -4rpx;
	width: 0;
	height: 0;
	border-left: 8rpx solid #666666;
	border-top: 6rpx solid transparent;
	border-bottom: 6rpx solid transparent;
}

.box {
	position: absolute;
	left: 180rpx;
	bottom: 40rpx;
	width: 40rpx;
	height: 30rpx;
	background-color: #e3f2fd;
	border: 2rpx solid #1976ff;
	border-radius: 6rpx;
}

.person {
	position: absolute;
	right: 50rpx;
	bottom: 50rpx;
}

.head {
	width: 30rpx;
	height: 30rpx;
	background-color: #ffb74d;
	border-radius: 50%;
	margin-bottom: 8rpx;
}

.body {
	width: 40rpx;
	height: 50rpx;
	background-color: #90a4ae;
	border-radius: 16rpx;
}

.empty-text {
	font-size: 28rpx;
	color: #999999;
	margin-bottom: 12rpx;
}

.empty-desc {
	font-size: 24rpx;
	color: #bbbbbb;
	text-align: center;
}

/* çŸ¥è¯†åº“åˆ—è¡¨ */
.knowledge-list {
	display: flex;
	flex-direction: column;
}

.list-header {
	display: flex;
	align-items: center;
	margin-bottom: 20rpx;
}

.list-title {
	font-size: 28rpx;
	font-weight: 600;
	color: #333333;
}

.list-count {
	font-size: 24rpx;
	color: #666666;
	margin-left: 8rpx;
}

.knowledge-items {
	display: flex;
	flex-direction: column;
	gap: 16rpx;
}

.knowledge-item {
	display: flex;
	align-items: center;
	gap: 16rpx;
	padding: 20rpx;
	background: #f8f9fa;
	border-radius: 12rpx;
	border: 1rpx solid #e9ecef;
}

.item-icon {
	font-size: 32rpx;
	width: 50rpx;
	height: 50rpx;
	background: #e3f2fd;
	border-radius: 10rpx;
	display: flex;
	align-items: center;
	justify-content: center;
}

.item-content {
	flex: 1;
	display: flex;
	flex-direction: column;
	gap: 4rpx;
}

.item-title {
	font-size: 26rpx;
	font-weight: 500;
	color: #333333;
}

.item-desc {
	font-size: 22rpx;
	color: #666666;
}

.item-time {
	font-size: 20rpx;
	color: #999999;
}

.item-actions {
	display: flex;
	align-items: center;
}

.action-text {
	font-size: 24rpx;
	color: #1976ff;
	padding: 8rpx 16rpx;
	background: rgba(25, 118, 255, 0.1);
	border-radius: 12rpx;
}

/* æ¨¡æ€æ¡†æ ·å¼ */
.modal-overlay {
	position: fixed;
	top: 0;
	left: 0;
	right: 0;
	bottom: 0;
	background-color: rgba(0, 0, 0, 0.5);
	display: flex;
	align-items: center;
	justify-content: center;
	z-index: 1000;
}

.modal-content {
	background-color: #ffffff;
	border-radius: 20rpx;
	width: 80%;
	max-width: 600rpx;
	max-height: 80vh;
	overflow: hidden;
}

.web-modal {
	width: 90%;
	max-width: 700rpx;
}

.modal-header {
	display: flex;
	justify-content: space-between;
	align-items: center;
	padding: 30rpx;
	border-bottom: 1rpx solid #e0e0e0;
}

.modal-title {
	font-size: 32rpx;
	font-weight: 600;
	color: #333333;
}

.close-btn {
	font-size: 40rpx;
	color: #999999;
	width: 40rpx;
	height: 40rpx;
	display: flex;
	align-items: center;
	justify-content: center;
}

.modal-body {
	padding: 30rpx;
}

.upload-option {
	padding: 30rpx 0;
	border-bottom: 1rpx solid #f0f0f0;
}

.upload-option:last-child {
	border-bottom: none;
}

.option-text {
	font-size: 28rpx;
	color: #333333;
}

.disclaimer {
	margin-bottom: 30rpx;
}

.disclaimer-text {
	font-size: 24rpx;
	color: #666666;
	line-height: 1.6;
}

.input-area {
	margin-bottom: 30rpx;
}

.url-input {
	width: 100%;
	height: 200rpx;
	border: 2rpx solid #e0e0e0;
	border-radius: 12rpx;
	padding: 20rpx;
	font-size: 28rpx;
	color: #333333;
	background-color: #ffffff;
	box-sizing: border-box;
}

.modal-footer {
	display: flex;
	gap: 20rpx;
	padding: 30rpx;
	border-top: 1rpx solid #e0e0e0;
}

.cancel-btn {
	flex: 1;
	border: 2rpx solid #e0e0e0;
	border-radius: 12rpx;
	padding: 20rpx;
	display: flex;
	align-items: center;
	justify-content: center;
}

.cancel-text {
	font-size: 28rpx;
	color: #666666;
}

.confirm-btn {
	flex: 1;
	background: linear-gradient(90deg, #1976ff, #1565c0);
	border-radius: 12rpx;
	padding: 20rpx;
	display: flex;
	align-items: center;
	justify-content: center;
}

.confirm-text {
	font-size: 28rpx;
	color: #ffffff;
	font-weight: 500;
}
</style> 